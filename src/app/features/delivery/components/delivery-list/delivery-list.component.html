<div class="delivery-list p-6 min-h-screen">
  <h1 class="text-3xl font-bold mb-6 text-center lg:text-left">
    Gestion des Livraisons
  </h1>

  <!-- Section de filtrage et de tri -->
  <div
    class="mb-4 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between bg-gray-50 p-4 rounded-lg shadow-md"
  >
    <!-- Filtres groupés dans des dropdowns -->
    <div class="flex flex-wrap gap-4 items-center">
      <!-- Filtrer par code postal -->
      <div class="dropdown dropdown-bottom">
        <div tabindex="0" role="button" class="btn btn-sm">
          Filtrer par code postal
        </div>
        <ul
          class="dropdown-content menu bg-base-100 rounded-box w-52 p-2 shadow"
        >
          <li *ngFor="let delivery of deliveries">
            <label class="form-control cursor-pointer">
              <span class="label-text">{{
                delivery.geocodedAddress.postalCode
              }}</span>
              <input
                type="checkbox"
                [checked]="
                  selectedPostalCodes.includes(
                    delivery.geocodedAddress.postalCode
                  )
                "
                (change)="
                  filterByPostalCode(
                    delivery.geocodedAddress.postalCode,
                    $event
                  )
                "
                class="checkbox checkbox-primary"
              />
            </label>
          </li>
        </ul>
      </div>

      <!-- Filtrer par statut -->
      <div class="dropdown dropdown-bottom">
        <div tabindex="0" role="button" class="btn btn-sm">
          Filtrer par statut
        </div>
        <ul
          class="dropdown-content menu bg-base-100 rounded-box w-52 p-2 shadow"
        >
          <li
            *ngFor="
              let status of [
                'Pending',
                'Delivered',
                'In Transit',
                'Scheduled',
                'Failed'
              ]
            "
          >
            <label class="form-control cursor-pointer">
              <span class="label-text">{{ translateStatus(status) }}</span>
              <input
                type="checkbox"
                [checked]="selectedStatuses.includes(status)"
                (change)="filterByStatus(status, $event)"
                class="checkbox checkbox-primary"
              />
            </label>
          </li>
        </ul>
      </div>

      <!-- Filtrer par type de produit -->
      <div class="dropdown dropdown-bottom">
        <div tabindex="0" role="button" class="btn btn-sm">
          Filtrer par type de produit
        </div>
        <ul
          class="dropdown-content menu bg-base-100 rounded-box w-52 p-2 shadow"
        >
          <li *ngFor="let productType of productTypes">
            <label class="form-control cursor-pointer">
              <span class="label-text">{{ productType }}</span>
              <input
                type="checkbox"
                [checked]="selectedProductTypes.includes(productType)"
                (change)="filterByProductType(productType, $event)"
                class="checkbox checkbox-primary"
              />
            </label>
          </li>
        </ul>
      </div>
    </div>

    <!-- Section de tri -->
    <div class="flex gap-4">
      <button class="btn btn-sm" (click)="sortByPostalCode()">
        Trier par Code Postal
      </button>
      <button class="btn btn-sm" (click)="sortByDeliveryDate()">
        Trier par Date de Livraison
      </button>
    </div>
  </div>

  <!-- Badges pour les filtres sélectionnés et bouton pour réinitialiser les filtres -->
  <div class="mb-4 flex flex-wrap gap-2">
    <!-- Badges pour les statuts filtrés -->
    <ng-container *ngFor="let status of selectedStatuses">
      <div
        class="flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm font-medium border border-blue-300"
      >
        {{ translateStatus(status) }}
        <button
          (click)="removeStatus(status)"
          class="ml-2 hover:text-blue-600 transition-colors duration-150"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </ng-container>

    <!-- Badges pour les types de produits filtrés -->
    <ng-container *ngFor="let productType of selectedProductTypes">
      <div
        class="flex items-center bg-green-100 text-green-800 rounded-full px-3 py-1 text-sm font-medium border border-green-300"
      >
        {{ productType }}
        <button
          (click)="removeProductType(productType)"
          class="ml-2 hover:text-green-600 transition-colors duration-150"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </ng-container>

    <!-- Badge pour réinitialiser tous les filtres -->
    <ng-container
      *ngIf="
        selectedPostalCodes.length ||
        selectedStatuses.length ||
        selectedProductTypes.length
      "
    >
      <button
        (click)="clearAllFilters()"
        class="bg-red-100 text-red-800 rounded-full px-4 py-1 text-sm font-medium border border-red-300 hover:bg-red-200 transition duration-150"
      >
        Réinitialiser les filtres
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 inline ml-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </ng-container>
  </div>

  <!-- Boutons d'Action lorsque des Livraisons sont Sélectionnées -->
  <div *ngIf="selectedDeliveries.length > 0" class="mb-4 flex gap-2">
    <button class="btn btn-sm btn-primary" (click)="assignToTourMethod()">
      Assigner à une tournée
    </button>
    <button class="btn btn-sm btn-secondary">Créer une tournée</button>
  </div>

  <!-- Tableau pour les Grands Écrans -->
  <div class="hidden lg:block overflow-x-auto shadow-md rounded-lg">
    <table class="min-w-full divide-y">
      <thead>
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            <div class="flex items-center space-x-2 min-w-20">
              <input
                type="checkbox"
                [checked]="isAllSelected()"
                (change)="toggleSelectAll()"
                aria-label="Sélectionner toutes les livraisons"
                class="form-checkbox h-4 w-4 text-indigo-600"
              />
              <div>
                <span>
                  {{ selectedDeliveries.length }} /
                  {{ filteredDeliveries.length }}
                </span>
              </div>
            </div>
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Date Prévue
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Adresse
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Produit
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Type
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Quantité
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Statut
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="divide-y">
        <tr *ngFor="let delivery of paginatedDeliveries">
          <!-- Case à Cocher pour Sélectionner la Livraison -->
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <input
              type="checkbox"
              [checked]="isSelected(delivery.id)"
              (change)="toggleSelection(delivery.id)"
            />
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            {{
              delivery.expectedDeliveryDate | date : "dd/MM/yyyy HH:mm" : "UTC"
            }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            {{ delivery.geocodedAddress.postalCode }}<br />
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <ng-container
              *ngIf="
                delivery.productDeliveries &&
                  delivery.productDeliveries.length > 0;
                else noProducts
              "
            >
              <ul>
                <li *ngFor="let productDelivery of delivery.productDeliveries">
                  {{ productDelivery.product.name }}
                </li>
              </ul>
            </ng-container>
            <ng-template #noProducts>N/A</ng-template>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <ng-container
              *ngIf="
                delivery.productDeliveries &&
                  delivery.productDeliveries.length > 0;
                else noTypes
              "
            >
              <ul>
                <li *ngFor="let productDelivery of delivery.productDeliveries">
                  {{ productDelivery.product.type }}
                </li>
              </ul>
            </ng-container>
            <ng-template #noTypes>N/A</ng-template>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <ng-container
              *ngIf="
                delivery.productDeliveries &&
                  delivery.productDeliveries.length > 0;
                else noQuantities
              "
            >
              <ul>
                <li *ngFor="let productDelivery of delivery.productDeliveries">
                  {{ productDelivery.quantity }}
                </li>
              </ul>
            </ng-container>
            <ng-template #noQuantities>N/A</ng-template>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <span class="badge" [ngClass]="getBadgeClass(delivery.status.name)">
              {{ translateStatus(delivery.status.name) }}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="flex gap-1">
              <button
                [routerLink]="['/livraisons', delivery.id]"
                class="btn btn-sm btn-primary flex items-center space-x-2"
              >
                <span>Voir</span>
              </button>
              <button
                [routerLink]="['/livraisons', delivery.id, 'edit']"
                class="btn btn-sm btn-secondary flex items-center space-x-2"
              >
                <span>Modifier</span>
              </button>
              <button
                (click)="deleteDelivery(delivery.id)"
                class="btn btn-sm btn-error flex items-center space-x-2"
              >
                <span>Supprimer</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Liste des Livraisons sous forme de Cartes pour les Petits Écrans -->
  <div class="block lg:hidden space-y-4 mt-6">
    <div class="flex-shrink-0 mb-4 space-x-2">
      <label class="font-semibold">Tout sélectionner</label>
      <input
        type="checkbox"
        [checked]="isAllSelected()"
        (change)="toggleSelectAll()"
        aria-label="Sélectionner toutes les livraisons"
      />
    </div>
    <div>
      <span>
        {{ selectedDeliveries.length }} / {{ filteredDeliveries.length }}
      </span>
    </div>
    <div
      *ngFor="let delivery of paginatedDeliveries"
      class="card shadow-md rounded-lg p-4"
    >
      <!-- Case à Cocher pour Sélectionner la Livraison -->
      <div class="flex-shrink-0">
        <input
          type="checkbox"
          [checked]="isSelected(delivery.id)"
          (change)="toggleSelection(delivery.id)"
          class="form-checkbox h-4 w-4 transition duration-150 ease-in-out"
        />
      </div>
      <!-- Date Prévue -->
      <div class="mb-2">
        <span class="font-semibold">Date Prévue:</span>
        <span>{{
          delivery.expectedDeliveryDate | date : "dd/MM/yyyy HH:mm : UTC"
        }}</span>
      </div>

      <!-- Adresse -->
      <div class="mb-2">
        <span class="font-semibold">Adresse:</span>
        <span>{{ delivery.geocodedAddress.postalCode }}</span>
      </div>

      <!-- Produit et Quantité -->
      <ng-container
        *ngIf="
          delivery.productDeliveries && delivery.productDeliveries.length > 0;
          else noProducts
        "
      >
        <div
          *ngFor="let productDelivery of delivery.productDeliveries"
          class="mb-2"
        >
          <span class="font-semibold">Produit:</span>
          <span>{{ productDelivery.product.name }}</span>
        </div>
        <div
          *ngFor="let productDelivery of delivery.productDeliveries"
          class="mb-2"
        >
          <span class="font-semibold">Type:</span>
          <span>{{ productDelivery.product.type }}</span>
        </div>
        <div
          *ngFor="let productDelivery of delivery.productDeliveries"
          class="mb-2"
        >
          <span class="font-semibold">Quantité:</span>
          <span>{{ productDelivery.quantity }}</span>
        </div>
      </ng-container>
      <ng-template #noProducts>
        <div class="mb-2">
          <span class="font-semibold">Produit:</span>
          <span>N/A</span>
        </div>
        <div class="mb-2">
          <span class="font-semibold">Quantité:</span>
          <span>N/A</span>
        </div>
      </ng-template>

      <!-- Statut -->
      <div class="mb-2">
        <span class="font-semibold">Statut:</span>
        <span class="badge" [ngClass]="getBadgeClass(delivery.status.name)">
          {{ translateStatus(delivery.status.name) }}
        </span>
      </div>

      <!-- Actions -->
      <div class="flex flex space-x-2 mt-4">
        <button
          [routerLink]="['/livraisons', delivery.id]"
          class="btn btn-sm btn-primary flex items-center space-x-2"
        >
          <span>Voir</span>
        </button>
        <button
          [routerLink]="['/livraisons', delivery.id, 'edit']"
          class="btn btn-sm btn-secondary flex items-center space-x-2"
        >
          <span>Modifier</span>
        </button>
        <button
          (click)="deleteDelivery(delivery.id)"
          class="btn btn-sm btn-error flex items-center space-x-2"
        >
          <span>Supprimer</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="flex justify-between items-center mt-4">
    <button
      [disabled]="currentPage === 1"
      (click)="changePage(currentPage - 1)"
      class="btn btn-outline btn-sm disabled:btn-disabled transition duration-200 ease-in-out hover:bg-gray-300"
    >
      Précédent
    </button>

    <span class="text-sm"> Page {{ currentPage }} sur {{ totalPages }} </span>

    <button
      [disabled]="currentPage === totalPages"
      (click)="changePage(currentPage + 1)"
      class="btn btn-outline btn-sm disabled:btn-disabled transition duration-200 ease-in-out hover:bg-gray-300"
    >
      Suivant
    </button>
  </div>
</div>
